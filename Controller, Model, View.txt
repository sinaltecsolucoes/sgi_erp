<?php
// Controller/ProducaoController.php

class ProducaoController extends AppController
{
    private $equipeModel;
    private $acaoModel;
    private $tipoProdutoModel;
    private $producaoModel;
    private $funcionarioModel;

    public function __construct()
    {
        // Garante a autenticação via AppController
        parent::__construct();

        $this->equipeModel = new EquipeModel();
        $this->acaoModel = new AcaoModel();
        $this->tipoProdutoModel = new TipoProdutoModel();
        $this->producaoModel = new ProducaoModel();
        $this->funcionarioModel = new FuncionarioModel();

        // Regra de Negócio: Apenas apontadores
        /* if ($_SESSION['funcionario_tipo'] !== 'apontador') {
            $_SESSION['erro'] = 'Acesso negado. Apenas Apontadores podem lançar a produção.';
            header('Location: /sgi_erp/dashboard');
            exit();
        } */
    }

    /**
     * Exibe a interface de lançamento de produção.
     * Rota: /producao
     */
    public function index()
    {
        $apontador_id = $_SESSION['funcionario_id'];

        // 1. Buscar a equipe do apontador para saber quem lançar
        $equipe = $this->equipeModel->buscarEquipeDoApontador($apontador_id);

        if (!$equipe) {
            $_SESSION['erro'] = 'Você precisa montar uma equipe primeiro para lançar a produção.';
            header('Location: /sgi_erp/equipes');
            exit();
        }

        // 2. Buscar os membros da equipe
        $membros = $this->equipeModel->buscarFuncionariosDaEquipe($equipe->id);

        // 3. Buscar as opções do formulário
        $acoes = $this->acaoModel->buscarTodas();
        $tipos_produto = $this->tipoProdutoModel->buscarTodos();

        // 4. Preparar dados para a View
        $dados = [
            'equipe' => $equipe,
            'membros' => $membros,
            'acoes' => $acoes,
            'tipos_produto' => $tipos_produto
        ];

        // Variáveis para o Template
        $title = "Lançamento de Produção";
        $content_view = 'View/producao.php';

        // Inclui o template principal
        require_once ROOT_PATH . 'View/template/main.php';
    }

    /**
     * Processa o formulário de lançamento de produção.
     * Rota: /producao/salvar
     */
    public function salvar()
    {
        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            header('Location: /sgi_erp/producao');
            exit();
        }

        // 1. Coleta e Sanitiza os dados do POST
        $funcionario_id = filter_input(INPUT_POST, 'funcionario_id', FILTER_VALIDATE_INT);
        $acao_id = filter_input(INPUT_POST, 'acao_id', FILTER_VALIDATE_INT);
        $tipo_produto_id = filter_input(INPUT_POST, 'tipo_produto_id', FILTER_VALIDATE_INT);
        $lote_produto = trim(filter_input(INPUT_POST, 'lote_produto', FILTER_SANITIZE_STRING));
        $hora_inicio = trim(filter_input(INPUT_POST, 'hora_inicio', FILTER_SANITIZE_STRING));
        $hora_fim = trim(filter_input(INPUT_POST, 'hora_fim', FILTER_SANITIZE_STRING));
        $quantidade_kg = filter_input(INPUT_POST, 'quantidade_kg', FILTER_VALIDATE_FLOAT);

        $apontador_id = $_SESSION['funcionario_id'];

        // 2. Busca a equipe para obter o ID da equipe atual
        $equipe = $this->equipeModel->buscarEquipeDoApontador($apontador_id);
        $equipe_id = $equipe ? $equipe->id : null;


        // 3. Validação
        if (!$funcionario_id || !$acao_id || !$tipo_produto_id || $quantidade_kg === false || $quantidade_kg <= 0 || !$equipe_id || empty($hora_inicio) || empty($hora_fim)) {
            $_SESSION['erro'] = 'Todos os campos são obrigatórios, incluindo Horário e Quantidade.';
            header('Location: /sgi_erp/producao');
            exit();
        }

        // 4. Validação do Lote: Checar se é obrigatório (Se usa_lote = TRUE, o lote não pode ser vazio)
        $tipoProdutoModel = new TipoProdutoModel();
        $tipoProduto = $tipoProdutoModel->buscarPorId($tipo_produto_id);

        if (($tipoProduto->usa_lote ?? 1) && empty($lote_produto)) { // Se usa_lote for TRUE e o lote estiver vazio
            $_SESSION['erro'] = 'O Lote do Produto é obrigatório para este tipo de produto/serviço.';
            header('Location: /sgi_erp/producao');
            exit();
        }

        // 5. Salva o Lançamento usando o Model
        if ($this->producaoModel->registrarLancamento(
            $funcionario_id,
            $acao_id,
            $tipo_produto_id,
            $lote_produto,
            $quantidade_kg,
            $equipe_id,
            $hora_inicio,
            $hora_fim
        )) {

            $_SESSION['sucesso'] = "Produção de **{$quantidade_kg} kg** registrada com sucesso!";
        } else {
            $_SESSION['erro'] = 'Erro interno ao salvar o registro de produção. Tente novamente.';
        }

        header('Location: /sgi_erp/producao');
        exit();
    }

    /**
     * Exibe a interface de lançamento de produção em massa.
     * Rota: /producao/massa
     */
    public function massa()
    {
        $apontador_id = $_SESSION['funcionario_id'];

        // 1. Buscar a equipe do apontador (necessária para saber quem listar)
        $equipe = $this->equipeModel->buscarEquipeDoApontador($apontador_id);

        if (!$equipe) {
            $_SESSION['erro'] = 'Você precisa montar uma equipe primeiro para lançar a produção.';
            header('Location: /sgi_erp/equipes');
            exit();
        }

        // 2. Buscar os membros da equipe (Os funcionários que terão campos de quantidade)
        $membros = $this->equipeModel->buscarFuncionariosDaEquipe($equipe->id);

        // 3. Buscar as opções (Ações e Produtos) para os dropdowns
        $acoes = $this->acaoModel->buscarTodas();
        $tipos_produto = $this->tipoProdutoModel->buscarTodos();

        // 4. Preparar dados para a View
        $dados = [
            'equipe' => $equipe,
            'membros' => $membros,
            'acoes' => $acoes,
            'tipos_produto' => $tipos_produto
        ];

        // Variáveis para o Template
        $title = "Lançamento em Massa por Equipe";
        $content_view = ROOT_PATH . 'View' . DS . 'producao_massa.php';

        require_once ROOT_PATH . 'View' . DS . 'template' . DS . 'main.php';
    }

    /**
     * Processa o formulário de lançamento em massa
     * Rota: /producao/massa/salvar
     */
    public function salvarMassa()
    {
        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            header('Location: /sgi_erp/producao/massa');
            exit();
        }

        // 1. Coleta e Valida os dados comuns
        $acao_id = filter_input(INPUT_POST, 'acao_id', FILTER_VALIDATE_INT);
        $tipo_produto_id = filter_input(INPUT_POST, 'tipo_produto_id', FILTER_VALIDATE_INT);
        $lote_produto = trim(filter_input(INPUT_POST, 'lote_produto', FILTER_SANITIZE_STRING));
        $hora_inicio = trim(filter_input(INPUT_POST, 'hora_inicio', FILTER_SANITIZE_STRING));
        $hora_fim = trim(filter_input(INPUT_POST, 'hora_fim', FILTER_SANITIZE_STRING));
        $apontador_id = $_SESSION['funcionario_id'];
        $quantidades = $_POST['quantidades'] ?? []; // Array associativo: [funcionario_id => quantidade_kg]

        $equipeModel = new EquipeModel(); // Garante que o Model esteja acessível
        $tipoProdutoModel = new TipoProdutoModel();

        $equipe = $equipeModel->buscarEquipeDoApontador($apontador_id);
        $equipe_id = $equipe ? $equipe->id : null;

        // 2. Validação Básica e de Tempo
        if (!$acao_id || !$tipo_produto_id || !$equipe_id || empty($hora_inicio) || empty($hora_fim)) {
            $_SESSION['erro'] = 'Erro: Ação, Produto, Horário de Início/Fim e Equipe são obrigatórios.';
            header('Location: /sgi_erp/producao/massa');
            exit();
        }

        // 3. Validação do Lote: Checar se é obrigatório (usa_lote = TRUE)
        $tipoProduto = $tipoProdutoModel->buscarPorId($tipo_produto_id);

        if (($tipoProduto->usa_lote ?? 1) && empty($lote_produto)) {
            $_SESSION['erro'] = 'O Lote do Produto é obrigatório para este tipo de produto/serviço.';
            header('Location: /sgi_erp/producao/massa');
            exit();
        }

        $registros_salvos = 0;
        $erros = 0;

        // 4. Itera sobre as quantidades lançadas
        foreach ($quantidades as $funcionario_id => $quantidade_str) {
            $quantidade_kg = filter_var($quantidade_str, FILTER_VALIDATE_FLOAT);

            if ($quantidade_kg > 0) {
                // 5. Salva o lançamento (reutilizando o método do ProducaoModel)
                if ($this->producaoModel->registrarLancamento(
                    $funcionario_id,
                    $acao_id,
                    $tipo_produto_id,
                    $lote_produto,
                    $quantidade_kg,
                    $equipe_id,
                    $hora_inicio,
                    $hora_fim
                )) {

                    $registros_salvos++;
                } else {
                    $erros++;
                }
            }
        }

        // 6. Feedback
        if ($registros_salvos > 0) {
            $_SESSION['sucesso'] = "Lançamento em massa concluído! Total de $registros_salvos registros salvos.";
        } elseif ($erros > 0) {
            $_SESSION['erro'] = "Nenhum registro salvo, mas ocorreram $erros erros no processamento.";
        } else {
            $_SESSION['erro'] = 'Nenhuma quantidade válida foi inserida.';
        }

        header('Location: /sgi_erp/producao/massa');
        exit();
    }

    public function editarMassa()
    {
        $data_selecionada = $_GET['data'] ?? date('Y-m-d');

        if (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $data_selecionada)) {
            $_SESSION['erro'] = 'Data inválida.';
            header('Location: /sgi_erp/producao/massa');
            exit;
        }

        // Busca lançamentos existentes na data
        $lancamentos_existentes = $this->producaoModel->buscarLancamentosPorData($data_selecionada);

        // Opções dos selects
        $acoes = $this->acaoModel->buscarTodas();
        $tipos_produto = $this->tipoProdutoModel->buscarTodos();

        // Equipe atual
        $apontador_id = $_SESSION['funcionario_id'];
        $equipe = $this->equipeModel->buscarEquipeDoApontador($apontador_id);
        if (!$equipe) {
            $_SESSION['erro'] = 'Você não tem equipe montada.';
            header('Location: /sgi_erp/equipes');
            exit;
        }
        $membros = $this->equipeModel->buscarFuncionariosDaEquipe($equipe->id);

        // Preenche valores globais (se já tiver lançamento)
        $acao_global = '';
        $produto_global = '';
        $lote_global = '';
        $hora_inicio = '';
        $hora_fim = '';
        $preenchidos = [];

        if (!empty($lancamentos_existentes)) {
            $primeiro = $lancamentos_existentes[0];
            $acao_global = $primeiro['acao_id'];
            $produto_global = $primeiro['tipo_produto_id'];
            $lote_global = $primeiro['lote_produto'] ?? '';
            $hora_inicio = $primeiro['hora_inicio'] ?? '';
            $hora_fim = $primeiro['hora_fim'] ?? '';

            foreach ($lancamentos_existentes as $l) {
                $preenchidos[$l['funcionario_id']] = $l['quantidade_kg'];
            }
        }

        $title = "EDIÇÃO EM MASSA - " . date('d/m/Y', strtotime($data_selecionada));

        $dados = compact(
            'data_selecionada',
            'equipe',
            'membros',
            'acoes',
            'tipos_produto',
            'preenchidos',
            'acao_global',
            'produto_global',
            'lote_global',
            'hora_inicio',
            'hora_fim'
        );

        $content_view = ROOT_PATH . 'View/producao_editar_massa.php';
        require_once ROOT_PATH . 'View/template/main.php';
    }

    public function salvarMassaEdit()
    {
        $data = $_POST['data'] ?? '';
        $acao_id = $_POST['acao_id'] ?? 0;
        $tipo_produto_id = $_POST['tipo_produto_id'] ?? 0;
        $lote_produto = $_POST['lote_produto'] ?? '';
        $hora_inicio = !empty($_POST['hora_inicio']) ? $_POST['hora_inicio'] : null;
        $hora_fim = !empty($_POST['hora_fim']) ? $_POST['hora_fim'] : null;
        $quantidades = $_POST['quantidades'] ?? [];

        if (empty($data) || empty($acao_id) || empty($tipo_produto_id)) {
            $_SESSION['erro'] = 'Preencha todos os campos obrigatórios.';
            header('Location: /sgi_erp/producao/editar-massa?data=' . $data);
            exit;
        }

        // Busca equipe
        $apontador_id = $_SESSION['funcionario_id'];
        $equipe = $this->equipeModel->buscarEquipeDoApontador($apontador_id);
        $equipe_id = $equipe->id ?? null;

        $salvos = 0;
        $atualizados = 0;
        $removidos = 0;

        foreach ($quantidades as $funcionario_id => $qtd_str) {
            $qtd = (float)str_replace(['.', ','], ['', '.'], $qtd_str);

            // Busca se já existe lançamento deste funcionário na data + ação + produto
            $existente = $this->producaoModel->buscarLancamentoUnico($data, $funcionario_id, $acao_id, $tipo_produto_id);

            if ($qtd > 0) {
                if ($existente) {
                    // UPDATE
                    $this->producaoModel->atualizarLancamento(
                        $existente['id'],
                        $qtd,
                        $lote_produto,
                        $hora_inicio,
                        $hora_fim
                    );
                    $atualizados++;
                } else {
                    // INSERT
                    $this->producaoModel->registrarLancamento(
                        $funcionario_id,
                        $acao_id,
                        $tipo_produto_id,
                        $lote_produto,
                        $qtd,
                        $equipe_id,
                        $hora_inicio,
                        $hora_fim
                    );
                    $salvos++;
                }
            } else {
                // REMOVE se existia e agora é zero
                if ($existente) {
                    $this->producaoModel->excluirLancamento($existente['id']);
                    $removidos++;
                }
            }
        }

        $_SESSION['sucesso'] = "Edição concluída! Salvos: $salvos | Atualizados: $atualizados | Removidos: $removidos";
        header('Location: /sgi_erp/producao/editar-massa?data=' . $data);
        exit;
    }

    public function editarDia()
    {
        // 1. Pega a data da URL ou usa a data atual (Y-m-d)
        $data = $_GET['data'] ?? date('Y-m-d');

        if (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $data)) {
            $data = date('Y-m-d');
        }

        // 2. Validação/Sanitização da data (Ajustada)
        // Se a data não for um formato YYYY-MM-DD válido, volta para a data atual.
        if (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $data)) {
            // Em vez de só redefinir a variável local $data, 
            // precisamos ter certeza que a view recebe o valor correto.
            $data = date('Y-m-d');
            // OPTIONAL: Se quiser informar o erro de data para o usuário
            if (isset($_GET['data'])) { // Só se a data foi enviada e estava errada
                $_SESSION['erro'] = 'Data informada é inválida. Exibindo dados da data atual.';
            }
        }

        // A variável $data é usada para buscar os lançamentos e é passada para a View 
        $data_selecionada = $data; // Renomeando para clareza com a View

        $lancamentos = $this->producaoModel->buscarTodosLancamentosDoDia($data_selecionada);

        // Cálculo do total por funcionário
        $totais = [];
        foreach ($lancamentos as $l) {
            $nome = $l['funcionario_nome'];
            if (!isset($totais[$nome])) $totais[$nome] = 0;
            $totais[$nome] += $l['quantidade_kg'];
        }

        $title = "EDITAR PRODUÇÃO - " . date('d/m/Y', strtotime($data));

        $dados = [
            'data_selecionada' => $data, // <- SEMPRE DEFINIDA
            'lancamentos' => $lancamentos,
            'acoes' => $this->acaoModel->buscarTodas(),
            'tipos_produto' => $this->tipoProdutoModel->buscarTodos(),
            'totais' => $totais // <- passa os totais pra view
        ];

        $content_view = ROOT_PATH . 'View/producao_editar_dia.php';
        require_once ROOT_PATH . 'View/template/main.php';
    }
}


<?php
// Model/ProducaoModel.php

class ProducaoModel
{
    private $db;
    private $table_producao = 'producao';

    public function __construct()
    {
        // Inicializa a conexão com o banco de dados
        $this->db = Database::getInstance()->connect();
    }

    /**
     * Registra um lançamento de produção na base de dados.
     * @param int $funcionario_id ID do funcionário.
     * @param int $acao_id ID da ação realizada.
     * @param int $tipo_produto_id ID do tipo de produto.
     * @param string $lote_produto NOVO: Lote do produto.
     * @param float $quantidade_kg Quantidade produzida em quilos.
     * @param int|null $equipe_id ID da equipe.
     * @return bool TRUE se a inserção for bem-sucedida, FALSE caso contrário.
     */
    public function registrarLancamento($funcionario_id, $acao_id, $tipo_produto_id, $lote_produto, $quantidade_kg, $equipe_id = null, $hora_inicio = null, $hora_fim = null)
    {
        $query = "INSERT INTO {$this->table_producao} 
                  (funcionario_id, acao_id, tipo_produto_id, lote_produto, quantidade_kg, data_hora, equipe_id, hora_inicio, hora_fim) 
                  VALUES 
                  (:funcionario_id, :acao_id, :tipo_produto_id, :lote_produto, :quantidade_kg, NOW(), :equipe_id, :hora_inicio, :hora_fim)";

        try {
            $stmt = $this->db->prepare($query);

            // Bind dos parâmetros
            $stmt->bindParam(':funcionario_id', $funcionario_id);
            $stmt->bindParam(':acao_id', $acao_id);
            $stmt->bindParam(':tipo_produto_id', $tipo_produto_id);
            $stmt->bindParam(':lote_produto', $lote_produto);
            $stmt->bindParam(':quantidade_kg', $quantidade_kg);
            $stmt->bindParam(':hora_inicio', $hora_inicio);
            $stmt->bindParam(':hora_fim', $hora_fim);

            // Tratamento especial para $equipe_id (pode ser NULL)
            if (is_null($equipe_id)) {
                $stmt->bindValue(':equipe_id', null, PDO::PARAM_NULL);
            } else {
                $stmt->bindParam(':equipe_id', $equipe_id);
            }

            return $stmt->execute();
        } catch (PDOException $e) {
            // Em caso de erro na consulta, logar ou tratar.
            // echo "Erro ao registrar produção: " . $e->getMessage();
            return false;
        }
    }

    /**
     * Soma a quantidade total de KG produzidos na data de hoje.
     * @return float O total de quilos produzidos.
     */
    public function somarProducaoHoje()
    {
        // Usa a data atual no início do dia
        $hoje_inicio = date('Y-m-d 00:00:00');
        // E o final do dia
        $hoje_fim = date('Y-m-d 23:59:59');

        $query = "SELECT 
                    SUM(quantidade_kg) AS total_kg_hoje
                  FROM 
                    {$this->table_producao}
                  WHERE 
                    data_hora BETWEEN :hoje_inicio AND :hoje_fim";

        try {
            $stmt = $this->db->prepare($query);
            $stmt->bindParam(':hoje_inicio', $hoje_inicio);
            $stmt->bindParam(':hoje_fim', $hoje_fim);
            $stmt->execute();

            // Retorna 0.00 se o resultado for nulo
            $resultado = $stmt->fetch()->total_kg_hoje;
            return (float)($resultado ?? 0.00);
        } catch (PDOException $e) {
            error_log("Erro ao somar produção: " . $e->getMessage());
            return 0.00;
        }
    }

    public function buscarLancamentosPorData($data)
    {
        $sql = "SELECT 
                p.id,
                p.funcionario_id,
                p.acao_id,
                p.tipo_produto_id,
                p.lote_produto,
                p.quantidade_kg,
                p.equipe_id,
                p.hora_inicio,
                p.hora_fim
            FROM {$this->table_producao} p
            WHERE DATE(p.data_hora) = :data
            ORDER BY p.funcionario_id";

        $stmt = $this->db->prepare($sql);
        $stmt->bindParam(':data', $data);
        $stmt->execute();
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    public function excluirLancamento($id)
    {
        $sql = "DELETE FROM producao WHERE id = ?";
        $stmt = $this->db->prepare($sql);
        $stmt->execute([$id]);
    }

    public function buscarLancamentoUnico($data, $funcionario_id, $acao_id, $tipo_produto_id)
    {
        $sql = "SELECT id, quantidade_kg 
            FROM producao 
            WHERE DATE(data_hora) = ? 
              AND funcionario_id = ? 
              AND acao_id = ? 
              AND tipo_produto_id = ?";

        $stmt = $this->db->prepare($sql);
        $stmt->execute([$data, $funcionario_id, $acao_id, $tipo_produto_id]);
        return $stmt->fetch(PDO::FETCH_ASSOC) ?: null;
    }

    public function atualizarLancamento($id, $quantidade_kg, $lote_produto, $hora_inicio, $hora_fim)
    {
        $sql = "UPDATE producao SET 
                quantidade_kg = :qtd,
                lote_produto = :lote,
                hora_inicio = :inicio,
                hora_fim = :fim
            WHERE id = :id";

        $stmt = $this->db->prepare($sql);
        $stmt->execute([
            ':qtd' => $quantidade_kg,
            ':lote' => $lote_produto,
            ':inicio' => $hora_inicio,
            ':fim' => $hora_fim,
            ':id' => $id
        ]);
    }

    public function buscarTodosLancamentosDoDia($data)
    {
        $sql = "SELECT 
                p.id,
                p.funcionario_id,
                f.nome as funcionario_nome,
                p.acao_id,
                a.nome as acao_nome,
                p.tipo_produto_id,
                tp.nome as produto_nome,
                p.quantidade_kg,
                p.lote_produto,
                p.hora_inicio,
                p.hora_fim
            FROM producao p
            JOIN funcionarios f ON p.funcionario_id = f.id
            JOIN acoes a ON p.acao_id = a.id
            JOIN tipos_produto tp ON p.tipo_produto_id = tp.id
            WHERE DATE(p.data_hora) = ?
            ORDER BY f.nome, p.hora_inicio";

        $stmt = $this->db->prepare($sql);
        $stmt->execute([$data]);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }
}


document.addEventListener('DOMContentLoaded', function () {
    let dadosOriginais = {};

    function aplicarMascaraKg(input) {
        let v = input.value.replace(/\D/g, '');
        if (!v) return;
        v = v.replace(/(\d)(\d{3})$/, '$1,$2');
        v = v.replace(/(?=(\d{3})+(\D))\B/g, '.');
        input.value = v;
    }

    function atualizarTotalDia(funcionarioNome) {
        let total = 0;
        document.querySelectorAll(`tr[data-funcionario="${funcionarioNome}"]`).forEach(row => {
            const kgText = row.querySelector('.kg-view').textContent;
            const kg = parseFloat(kgText.replace(/\./g, '').replace(',', '.') || 0);
            total += kg;
        });
        const formato = total.toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
        document.querySelectorAll(`tr[data-funcionario="${funcionarioNome}"] .total-dia`)
            .forEach(el => el.textContent = formato + ' kg');
    }

    document.addEventListener('click', function (e) {
        const btnEditar = e.target.closest('.btn-editar');
        const btnCancelar = e.target.closest('.btn-cancelar');
        const tr = e.target.closest('tr');
        if (!tr) return;

        if (btnEditar) {
            if (btnEditar.textContent.trim() === 'Editar') {
                // SALVA VALORES ORIGINAIS
                dadosOriginais[tr.dataset.id] = {
                    acao: tr.querySelector('.acao-view').textContent,
                    produto: tr.querySelector('.produto-view').textContent,
                    kg: tr.querySelector('.kg-view').textContent,
                    inicio: tr.querySelector('.inicio-view').textContent,
                    fim: tr.querySelector('.fim-view').textContent
                };

                // ATIVA MODO EDIÇÃO
                tr.querySelectorAll('.view-mode').forEach(el => el.classList.add('d-none'));
                tr.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('d-none'));


                // 1. Pega os IDs atuais (GARANTINDO QUE SEJA UMA STRING LIMPA)
                const acaoIdAtual = String(tr.dataset.acaoId).trim();
                const produtoIdAtual = String(tr.dataset.produtoId).trim();

                // 2. Seleciona o valor exato no dropdown da Ação
                const selectAcao = tr.querySelector('.acao-select');
                if (selectAcao && acaoIdAtual) {
                    // Força a atribuição do valor (que deve ser o ID da option)
                    selectAcao.value = acaoIdAtual;
                }

                // 3. Seleciona o valor exato no dropdown do Produto
                const selectProduto = tr.querySelector('.produto-select');
                if (selectProduto && produtoIdAtual) {
                    // Força a atribuição do valor (que deve ser o ID da option)
                    selectProduto.value = produtoIdAtual;
                }

                btnEditar.innerHTML = 'Salvar';
                btnEditar.classList.remove('btn-success');
                btnEditar.classList.add('btn-primary');
                tr.querySelector('.btn-cancelar').classList.remove('d-none');

                // Máscara KG
                const kgInput = tr.querySelector('.kg-input');
                aplicarMascaraKg(kgInput);
                kgInput.addEventListener('input', () => aplicarMascaraKg(kgInput));

            } else {
                // SALVAR
                const dados = {
                    id: tr.dataset.id,
                    acao_id: tr.querySelector('.acao-select').value,
                    tipo_produto_id: tr.querySelector('.produto-select').value,
                    quantidade_kg: parseFloat(tr.querySelector('.kg-input').value.replace(/\./g, '').replace(',', '.') || 0),
                    hora_inicio: tr.querySelector('.hora-inicio').value || null,
                    hora_fim: tr.querySelector('.hora-fim').value || null
                };

                fetch('/sgi_erp/producao/salvar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                })
                    .then(r => r.json())
                    .then(res => {
                        if (res.success) {
                            // Atualiza labels com os novos valores
                            tr.querySelector('.acao-view').textContent = tr.querySelector('.acao-select option:checked').textContent;
                            tr.querySelector('.produto-view').textContent = tr.querySelector('.produto-select option:checked').textContent;
                            tr.querySelector('.kg-view').textContent = tr.querySelector('.kg-input').value;
                            tr.querySelector('.inicio-view').textContent = tr.querySelector('.hora-inicio').value || '--:--';
                            tr.querySelector('.fim-view').textContent = tr.querySelector('.hora-fim').value || '--:--';

                            // Volta ao modo visualização
                            tr.querySelectorAll('.view-mode').forEach(el => el.classList.remove('d-none'));
                            tr.querySelectorAll('.edit-mode').forEach(el => el.classList.add('d-none'));
                            btnEditar.innerHTML = 'Editar';
                            btnEditar.classList.remove('btn-primary');
                            btnEditar.classList.add('btn-success');
                            tr.querySelector('.btn-cancelar').classList.add('d-none');

                            atualizarTotalDia(tr.dataset.funcionario);
                            Swal.fire('Salvo!', 'Tudo atualizado com sucesso.', 'success');
                            tr.style.backgroundColor = '#d4edda';
                            setTimeout(() => tr.style.backgroundColor = '', 1000);
                        } else {
                            Swal.fire('Erro', res.msg || 'Falha ao salvar', 'error');
                        }
                    });
            }
        }

        if (btnCancelar) {
            const orig = dadosOriginais[tr.dataset.id];
            if (orig) {
                tr.querySelector('.acao-view').textContent = orig.acao;
                tr.querySelector('.produto-view').textContent = orig.produto;
                tr.querySelector('.kg-view').textContent = orig.kg;
                tr.querySelector('.inicio-view').textContent = orig.inicio;
                tr.querySelector('.fim-view').textContent = orig.fim;
            }

            tr.querySelectorAll('.view-mode').forEach(el => el.classList.remove('d-none'));
            tr.querySelectorAll('.edit-mode').forEach(el => el.classList.add('d-none'));
            tr.querySelector('.btn-editar').innerHTML = 'Editar';
            tr.querySelector('.btn-editar').classList.remove('btn-primary');
            tr.querySelector('.btn-editar').classList.add('btn-success');
            tr.querySelector('.btn-cancelar').classList.add('d-none');
        }
    });
});